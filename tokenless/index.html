<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ACM Seguros</title>
  <link href="styles/style.css" rel="stylesheet"></link>
</head>

<body>
  <header class="settings" onclick="openSettings()">
    <h2 class="title">‚öôÔ∏è Configura√ß√µes</h2>

    <fieldset class="form">
      <div class="field batch-key">
        <label>Request Signature Key</label>
        <input type="text" id="key" name="key" required="true" />
      </div>

      <div class="field enviroment">
        <label>Environment</label>
        <select id="request_enviroment">
          <option value="sandbox" selected>Sandbox</option>
          <option value="production">Produ√ß√£o</option>
        </select>
      </div>

      <div class="field">
        <label>Vers√£o</label>
        <select id="request_version">
          <option value="v1">v1</option>
          <option value="v2" selected>v2</option>
        </select>
      </div>

      <div class="action">
        <button id="setButton" type="submit" class="button" onclick="setWidget()">
          Carregar
        </button>
      </div>
    </fieldset>
  </header>

  <main class="main">
    <h2>üôã Preencha seus dados</h2>

    <form id="form" action="success.html" onsubmit="return false">
      <filedset class="signer-info">
        <div class="field">
          <label>Nome</label><br>
          <input type="text" id="name" name="name" />
        </div>
        <div class="field">
          <label>CPF</label><br>
          <input type="text" id="cpf" name="cpf" />
        </div>
        <div class="field">
          <label>Data de nascimento</label><br>
          <input type="date" id="birthdate" name="birthdate" />
        </div>
      </filedset>

      <div id="widget" class="container"></div>

      <div class="action">
        <button type="submit" class="button large" id="submitButton" disabled="disabled">
          Clique para assinar
        </button>
      </div>
    </form>
  </main>

  <script type="text/javascript">
    const TOKENLESS_SCRIPT_ID = 'tokenlessWidgetScript'

    const scriptMap = {
      v1: {
        'sandbox': 'https://sandbox.clicksign.com/tokenlessWidget.js',
        'production': 'https://app.clicksign.com/tokenlessWidget.js',
      },
      v2: {
        'sandbox': 'https://sandbox.clicksign.com/tokenlessWidget-v2.0.0.js',
        'production': 'https://app.clicksign.com/tokenlessWidget-v2.0.0.js',
      }
    }

    function openSettings() {
      document.getElementsByClassName('settings')[0].classList.remove('closed');
    }

    function closeSettings() {
      document.getElementsByClassName('settings')[0].classList.add('closed');
    }

    function getSelectedConfig() {
      const key = document.getElementById('key').value;
      const environment = document.getElementById('request_enviroment').value;
      const version = document.getElementById('request_version').value;

      return {
        key,
        environment,
        version
      }
    }

    async function loadTokenlessScript(env, version) {
      const oldScript = document.getElementById(TOKENLESS_SCRIPT_ID);
      const script = document.createElement('script');

      script.setAttribute('src', scriptMap[version][env]);
      script.setAttribute('id', TOKENLESS_SCRIPT_ID);

      if(oldScript) oldScript.remove();
      document.head.appendChild(script);

      return new Promise((resolve, reject) => {
        script.onload = resolve;
        script.onerror = reject;
      })
    }

    async function setWidget(){
      const submitButton = document.getElementById('submitButton')
      const { key, environment, version } = getSelectedConfig();

      await loadTokenlessScript(environment, version);

      const tw = new tokenlessWidget(key, environment)

      tw.injectLoader('<div class="loader"><div></div><div></div><div></div><div></div></div>')
      closeSettings()
      tw.attach('click', 'submitButton', () => {
        const data = {
          "signature": {
            "name": document.getElementById("name").value,
            "birthday": document.getElementById("birthdate").value,
            "documentation": document.getElementById("cpf").value
          }
        }

        tw.sign(data).then(() => {
          submitButton.setAttribute("value", "Assinatura realizada com sucesso!");
          submitButton.setAttribute("style", "background-color: green;");
          console.log('Assinatura realizada com sucesso!')
        }).catch((error) => {
          submitButton.setAttribute("value", `Erro ao assinar o documento. Confira log`);
          submitButton.setAttribute("style", "background-color: red;");
          console.log(error.code, error.message)
        })
      })

      tw.mount({
        'containerId':'widget',
        'textTemplate': 'banco_acme_1'
      })

      submitButton.removeAttribute('disabled')
    }
  </script>

  <script defer>
    const { environment, version } = getSelectedConfig();

    loadTokenlessScript(environment, version);
  </script>
</body>
</html>
